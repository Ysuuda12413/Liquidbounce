package net.ccbluex.liquidbounce.features.module.modules.exploit

import net.ccbluex.liquidbounce.event.PacketEvent
import net.ccbluex.liquidbounce.event.UpdateEvent
import net.ccbluex.liquidbounce.event.handler
import net.ccbluex.liquidbounce.features.module.Category
import net.ccbluex.liquidbounce.features.module.Module
import net.minecraft.network.Packet
import net.minecraft.network.play.client.*
import java.util.*

object IntaveDisabler : Module(
    name = "IntaveDisabler",
    category = Category.EXPLOIT,
) {
    private val delayedTransactions: Queue<Packet<*>> = LinkedList()
    private var lastKeepAlive = 0L
    private var lastTransactionSend = 0L
    private var lastAbilities = 0L
    private var ticks = 0

    // Delay ranges (randomized)
    private fun keepAliveDelay() = (370L..570L).random()
    private fun txDelay() = (55L..138L).random()
    private fun abilitiesDelay() = (90L..170L).random()
    private fun txBatchSize() = (1..2).random()

    val onPacket = handler<PacketEvent> { event ->
        val packet = event.packet

        // Xử lý ConfirmTransaction bình thường, KHÔNG giữ quá nhiều
        if (packet is C0FPacketConfirmTransaction) {
            if (delayedTransactions.size < 8) {
                delayedTransactions.add(packet)
                event.cancelEvent()
            }
        }

        // Không delay quá lâu các packet abilities/keepAlive
        if (packet is C13PacketPlayerAbilities) {
            if (packet.isFlying && !mc.thePlayer.capabilities.allowFlying) event.cancelEvent()
            if (System.currentTimeMillis() - lastAbilities < abilitiesDelay()) event.cancelEvent()
            else lastAbilities = System.currentTimeMillis()
        }

        if (packet is C00PacketKeepAlive) {
            if (System.currentTimeMillis() - lastKeepAlive < keepAliveDelay()) event.cancelEvent()
            else lastKeepAlive = System.currentTimeMillis()
        }

        // KHÔNG CHẶN C03PacketPlayer (movement packet), để tự nhiên
    }

    val onUpdate = handler<UpdateEvent> {
        ticks++
        if (delayedTransactions.isNotEmpty()) {
            val now = System.currentTimeMillis()
            if (now - lastTransactionSend > txDelay() && Math.random() > 0.30) {
                repeat(txBatchSize()) {
                    if (delayedTransactions.isNotEmpty())
                        mc.netHandler.addToSendQueue(delayedTransactions.poll())
                }
                lastTransactionSend = now
            }
        }
        // Đừng giữ queue quá lớn
        if (delayedTransactions.size > 12) repeat((1..2).random()) { delayedTransactions.poll() }
    }

    override val tag: String
        get() = "DuyunDz On Top"
}