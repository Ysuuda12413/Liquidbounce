package net.ccbluex.liquidbounce.features.module.modules.exploit

import net.ccbluex.liquidbounce.event.PacketEvent
import net.ccbluex.liquidbounce.ui.utils.client.PacketUtils
import net.ccbluex.liquidbounce.event.handler
import net.ccbluex.liquidbounce.features.module.Category
import net.ccbluex.liquidbounce.features.module.Module
import net.minecraft.network.play.client.*
import kotlin.random.Random

object IntaveDisabler : Module(
    name = "IntaveDisabler",
    category = Category.EXPLOIT,
) {
    private var lastAttackTime = 0L

    val onPacket = handler<PacketEvent> { event ->
        val packet = event.packet

        // ----- KillAura Bypass -----
        if (packet is C02PacketUseEntity && packet.action == C02PacketUseEntity.Action.ATTACK) {
            val delay = (40..100).random()
            if (System.currentTimeMillis() - lastAttackTime < delay) {
                event.cancelEvent()
                return@handler
            }
            lastAttackTime = System.currentTimeMillis()
        }

        // ----- Scaffold Bypass -----
        if (packet is C08PacketPlayerBlockPlacement) {
            val newPacket = C08PacketPlayerBlockPlacement(
                packet.position,
                packet.placedBlockDirection,
                packet.stack,
                (packet.placedBlockOffsetX + Random.nextDouble(-0.1, 0.1)).toFloat(),
                (packet.placedBlockOffsetY + Random.nextDouble(-0.1, 0.1)).toFloat(),
                (packet.placedBlockOffsetZ + Random.nextDouble(-0.1, 0.1)).toFloat()
            )
            event.cancelEvent()
            PacketUtils.sendPacket(newPacket, triggerEvent = false)
        }
    }
    override val tag: String
        get() = "DuyunDz On Top"
}